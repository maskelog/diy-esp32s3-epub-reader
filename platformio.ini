; PlatformIO Project Configuration File
;
;   Build options: build flags, source filter
;   Upload options: custom upload port, speed and extra flags
;   Library options: dependencies, extra library storages
;   Advanced options: extra scripting
;
; Please visit documentation for the other options and examples
; https://docs.platformio.org/page/projectconf.html

[platformio]
; Default to the Paper S3 ESP-IDF environment
default_envs = m5paper

[common]
platform = espressif32
framework = espidf
board = esp32dev
;upload_port = /dev/cu.SLAB_USBtoUART 
;monitor_port = /dev/cu.SLAB_USBtoUART
monitor_speed = 115200
monitor_filters = esp32_exception_decoder
lib_deps =
  https://github.com/zeux/pugixml.git
build_flags =
  ; maximim speed
  -Ofast
  ; needed to stop the png library tying to pull in Arduino.h
  -D__MCUXPRESSO
  ; device has PRSRAM
  ; and should be used for ram intensive display work
  -DBOARD_HAS_PSRAM
  ; Logging. Leave enabled for first builds and debugging. Comment to disable
  -D LOG_ENABLED
  -DMINIZ_NO_ZLIB_COMPATIBLE_NAMES
 

[esp32_common]
platform = ${common.platform}
framework = ${common.framework}
board = ${common.board}
;upload_port = ${common.upload_port}
;monitor_port = ${common.monitor_port}
monitor_speed = ${common.monitor_speed}
monitor_filters = ${common.monitor_filters}
build_flags = ${common.build_flags}
lib_deps = ${common.lib_deps}
board_build.partitions = partitions.csv



[env:native]
platform = native
test_build_src = false
targets = test
# enable C++11 extensions
build_flags =
  -std=c++11
  -D__MCUXPRESSO
lib_deps =
  https://github.com/leethomason/tinyxml2.git
lib_ignore = 
  touch
  epdiy
  sd_card
  spiffs
  FT6X36
  m5Paper
debug_test = *

[env:paper_s3_idf]
extends = esp32_common
board = esp32-s3-devkitm-1
board_upload.flash_size = 16MB
board_upload.maximum_size = 16777216
build_unflags =
  -Ofast
build_flags =
  ${common.build_flags}
  -Os
  ; ESP32-S3 PaperS3 board using epdiy renderer
  -DBOARD_TYPE_PAPER_S3
  ; Enable ADC-based battery monitoring on Paper S3. VBAT is routed
  ; through a 2:1 divider to GPIO3, which corresponds to ADC1 channel 2
  ; (same mapping used by BatteryPaperS3::read_voltage in epub-papers3).
  -DBATTERY_ADC_CHANNEL=ADC1_CHANNEL_2
  ; use ED047TC2 960x540 display config from epdiy for now
  -DCONFIG_EPD_DISPLAY_TYPE_ED047TC2
  -DCONFIG_EPD_BOARD_REVISION_LILYGO_T5_47
  -Ilib_freetype/include/freetype2
  -Llib_freetype/lib
  -lfreetype
  -DUSE_FREETYPE
  -DUSE_PUGIXML
  -DPUGIXML_NO_EXCEPTIONS
  -DUSE_PNGLE
  -Ilib/pngle/src
  ; use SD card for EPUB storage on PaperS3 (no SPIFFS). Board::start_filesystem()
  ; mounts an SD card at /fs using the SD_CARD_PIN_NUM_* pins below.
  -DSD_CARD_PIN_NUM_MISO=GPIO_NUM_40
  -DSD_CARD_PIN_NUM_MOSI=GPIO_NUM_38
  -DSD_CARD_PIN_NUM_CLK=GPIO_NUM_39
  -DSD_CARD_PIN_NUM_CS=GPIO_NUM_47
lib_deps =
  ${common.lib_deps}
lib_ignore =
  epdiy
  touch
  FT6X36
  m5Paper
lib_extra_dirs = 
  lib_freetype/lib
  lib/efont
lib_archive = yes
lib_compat_mode = soft
lib_ldf_mode = chain

[env:paper_s3_release]

extends = esp32_common

board = esp32-s3-devkitm-1

board_upload.flash_size = 16MB

board_upload.maximum_size = 16777216

build_unflags =

  -Ofast

  -D LOG_ENABLED

build_flags =

  ${common.build_flags}

  -Os

  -DBOARD_TYPE_PAPER_S3

  ; Enable ADC-based battery monitoring on Paper S3 (GPIO3 = ADC1_CHANNEL_2

  ; with a 2:1 VBAT divider), matching the epub-papers3 helper.

  -DBATTERY_ADC_CHANNEL=ADC1_CHANNEL_2

  -DCONFIG_EPD_DISPLAY_TYPE_ED047TC2

  -DCONFIG_EPD_BOARD_REVISION_LILYGO_T5_47

  -Ilib_freetype/include/freetype2

  -Llib_freetype/lib

  -lfreetype

  -DUSE_FREETYPE

  -DUSE_PUGIXML

  -DPUGIXML_NO_EXCEPTIONS

  -DUSE_PNGLE

  -Ilib/pngle/src

  -DSD_CARD_PIN_NUM_MISO=GPIO_NUM_40

  -DSD_CARD_PIN_NUM_MOSI=GPIO_NUM_38

  -DSD_CARD_PIN_NUM_CLK=GPIO_NUM_39

  -DSD_CARD_PIN_NUM_CS=GPIO_NUM_47

lib_deps =

  ${common.lib_deps}

lib_ignore =

  epdiy

  touch

  FT6X36

  m5Paper

lib_extra_dirs = lib_freetype/lib

lib_archive =

  yes

lib_compat_mode = soft

lib_ldf_mode = chain



[env:m5paper]
platform = espressif32
board = m5stack-fire
framework = arduino

; M5Paper uses ESP32 with specific configuration
board_build.partitions = partitions.csv
monitor_speed = 115200

; Required libraries
lib_deps =
    ${common.lib_deps}
    m5stack/M5GFX@^0.1.16
    m5stack/M5Unified@^0.1.16
    tanakamasayuki/efont Unicode Font Data

; Exclude libraries not needed for M5Paper
lib_ignore =
    epdiy
    touch
    FT6X36
    miniz-2.2.0.backup
    miniz-2.2.0.backup.disabled

; Build flags - Enable PSRAM support and M5Paper board type
build_unflags =
    -Ofast

build_flags =
    ${common.build_flags}
    -D CONFIG_ARDUINO_LOOP_STACK_SIZE=16384
    -Os
    -DBOARD_HAS_PSRAM
    -mfix-esp32-psram-cache-issue
    -DBOARD_TYPE_M5_PAPER
    -DMINIZ_NO_ZLIB_COMPATIBLE_NAMES
    -DUSE_PUGIXML
    -DPUGIXML_NO_EXCEPTIONS
    -Ilib/miniz-3.1.0
    -Wl,--allow-multiple-definition
    -ffunction-sections
    -fdata-sections
    -Wl,--gc-sections

; Only compile necessary source files for M5Paper
build_src_filter =
    +<main.cpp>
    +<boards/Board.cpp>
    +<boards/M5Paper.cpp>
    +<boards/battery/M5PaperBattery.cpp>
    +<boards/controls/M5PaperButtonControls.cpp>
    +<boards/controls/M5PaperTouchControls.cpp>
    +<lib/Epub>
    +<lib/Fonts>
    +<lib/Images>